## Node 와 Vue를 GitHub Actions를 이용하여 배포하기

### 작업순서

1. Vue 프론트엔드 빌드
2. node 소스 압축파일 만들기
3. Naver Cloud 서버 준비 (Ubuntu 가상 서버)
4. 패키지 설치(nvm, nginx, node, unzip)
5. 서버에 vue 빌드한 파일 업로드
6. 서버에 node 소스 업로드(.env 포함)
7. PM2로 Node 서버 실행(&, nohup)
8. Nginx로 프록시 설정
9. github action

### 1. Vue 프론트엔드 빌드

```sh
cd frontend
npm run build
```

### 2. node 소스 압축파일 만들기

```sh
cd backapp
git archive --format=zip main -o ../backapp.zip
```

### 3. Naver Cloud 서버 준비 (Ubuntu 가상 서버)

[참조](https://devmg.tistory.com/346){\_target=blank}

### 5. 서버에 vue 빌드한 파일 업로드

```sh
mkdir /var/www/frontapp
sudo chown -R ubuntu:ubuntu /var/www
sudo chmod -R 755 /var/www
# dist 폴더의 파일들을 /var/www/frontapp 폴더로 복사
```

### 6. 서버에 node 소스 업로드(.env 포함)

```sh
# 폴더 생성
mkdir ~/backapp

# backapp 폴더에 압축파일 업로드

# 압출풀기
unzip backapp.zip
```

### 7. PM2로 Node 서버 실행(&, nohup)

```sh
# pm2 설치
npm install -g pm2

# node 서버 구동
pm2 start app.js --name app

# 지금 실행 중인 모든 Node 프로세스 목록을 저장
pm2 save

# 서버가 부팅될 때 PM2가 자동으로 실행되도록 OS에 등록
pm2 startup

# 테스트
curl http://localhost:3000/guestbook
```

### 8. Nginx로 프록시 설정

```bash
sudo nano /etc/nginx/sites-available/frontapp
```

```sh
server {
    listen 80;
    server_name _;

    root /var/www/frontapp;
    index index.html;

    # API 요청을 Node.js 백엔드 서버로 프록시
    location /api/ {
        proxy_pass http://localhost:3000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}

```

```bash
sudo rm /etc/nginx/sites-enabled/default
sudo ln -s /etc/nginx/sites-available/frontapp /etc/nginx/sites-enabled/

# 설정파일 문법검사
sudo nginx -t

# nginx 다시시작
sudo systemctl reload nginx

# 테스트
curl http://localhost/api/guestbook
```

### 10. [github action](https://docs.github.com/ko/actions/writing-workflows/quickstart)

```
GitHub
  ↓ (push)
GitHub Actions
  ↓
[frontapp 수정 -> Front Build → 서버 업로드 → Nginx 반영]
[backapp 수정 -> Back Deploy → 서버 업로드 → PM2 무중단 재시작]
```

##### [GitHub에 Secrets 등록](https://docs.github.com/ko/actions/how-tos/write-workflows/choose-what-workflows-do/use-secrets)

GitHub → Settings → Secrets → Actions

| 키 이름    | 값                   | 설명                     |
| :--------- | :------------------- | :----------------------- |
| HOST       | 127.0.0.1            | 서버 주소 또는 IP        |
| USER       | root                 | ubuntu                   |
| KEY        |                      | SSH 개인키 (id_rsa) 내용 |
| FRONT_PATH | /var/www/frontapp    | front 정적파일 위치      |
| BACK_PATH  | /home/ubuntu/backapp | node 소스 위치           |

#### front workflow

```yml
name: Deploy Frontend

on:
  push:
    paths:
      - "frontapp/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: |
          cd frontapp
          npm install
          npm run build
          ls -al dist

      - name: Sync dist to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          source: "frontapp/dist/*"
          target: ${{ secrets.FRONT_PATH }}
          rm: true
```

#### backapp workflow

scp 이용하여 파일 전송

```yml
name: Backend Deploy

on:
  push:
    paths:
      - "backapp/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Upload to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          source: "backapp/*"
          target: ${{ secrets.BACK_PATH }}
          rm: true

      - name: Restart Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            cd ${{ secrets.BACK_PATH }}
            npm install  --omit=dev
            pm2 reload app || pm2 start app.js --name app
```

`npm install --omit=dev` 은 package.json 에 정의된 dependencies 만 설치함

- dependencies → 앱이 실제 실행될 때 필요한 모듈
- devDependencies → 개발할 때만 필요한 모듈 (테스트, 빌드, 린트 등)
