## vue + node 수동 배포

### 작업순서

1. vue와 node 연동하기(Vue 정적파일 서빙 + API 연결)
2. Naver Cloud 서버 준비 (Ubuntu 가상 서버)
3. 서버에 node 설치
4. 서버에 파일 업로드 (Vue 빌드 + Node 서버)
5. PM2로 Node 서버 실행(클러스터 무중단 서비스)
6. Nginx로 프록시 설정

### 1. vue와 node 연동하기

vue 빌드된 파일을 backapp에 복사하고 접근할 수 있는 라우트 추가해야합니다.  
빌드된 파일은 `dist` 폴더에 생성됩니다.

#### vue build

```sh
# vue vuild
cd frontapp
npm run build

# dist 폴더를 backapp의 public 폴더로 복사
mkdir ..\backapp\public
copy dist\* ..\backapp\public
```

#### backapp/app.js 수정

Node만을 실행했을 때 Vue도 함께 실행되므로 Vue에서 만든 front에 접근하기 위해선 접근할 url을 지정.

```javascript
const express = require("express");
const app = express();
const port = 3000;

const guestbookRouter = require("./routes/guestbook");

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use("/api/guestbook", guestbookRouter);

// app.get("/", (req, res) => {
//   console.log(req.url);
//   res.send("Hello World! 6");
// });

// public 폴더를 정적 파일 디렉토리로 지정
app.use(express.static("public"));

const path = require("path");

//'/' endpoint에 vue의 index.html을 라우팅함.
app.get("/", function (req, res, next) {
  res.sendFile(path.join(__dirname, "./public", "index.html"));
});

// 새로고침해도 동작하도록 404 error 처리 미들웨어 추가
app.use((req, res) => {
  res.status(404).sendFile(path.join(__dirname, "./public", "index.html"));
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port} http://localhost:3000`);
});
```

추가할 내용

```javascript
// 주석으로 처리
// app.get("/", (req, res) => {
//   console.log(req.url);
//   res.send("Hello World! 6");
// });

// public 폴더를 정적 파일 디렉토리로 지정
app.use(express.static("public"));

const path = require("path");

//'/' endpoint에 vue의 index.html을 라우팅함.
app.get("/", function (req, res, next) {
  res.sendFile(path.join(__dirname, "./public", "index.html"));
});

// 새로고침해도 동작하도록 404 error 처리 미들웨어 추가
app.use((req, res) => {
  res.status(404).sendFile(path.join(__dirname, "./public", "index.html"));
});
```

#### 테스트

브라우저에서 테스트. node만 실행해도 vue도 같이 동작됨. 3000포트로 테스트하면 vue 메인페이지가 나와야 함.

```
http://localhost:3000
```

### 2. Naver Cloud 서버 준비 (Ubuntu 가상 서버)

네이버 서버 구축 : https://devmg.tistory.com/346

### 3. 서버에 node 설치

```sh
# 패키지 업데이트
sudo apt-get update

# nvm 설치
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.1/install.sh | bash
source ~/.bashrc


# nvm 설치 확인
nvm --version

# nvm 명령어로 node와 npm을 설치
nvm install 24.11.0
```

### 4. 클라우드 서버에 backapp 폴더 전송

backapp 폴더 압축하여 서버로 전송

로컬에서 작업

```sh
node_modules 폴더삭제
backapp 폴더 압축해서 서버로 전송
```

서버에서 작업

```sh

# backapp 폴더에 압축파일 업로드

#unzip 설치
sudo apt install unzip

# 압출풀기(-o 기존파일 덮어쓰기)
cd ~
unzip -o backapp.zip
```

### 5. 서버 실행

```sh
# backapp 폴더로 이동
cd ~/backapp

# 노드 서버 패키지 설치
npm install

# pm2 global(전역) 설치
npm install pm2 -g

# pm2 실행
pm2 start app.js --name  app

# pm2로 실행중인 프로세스 확인
pm2 list

# 프로세스 로그 확인
pm2 logs app
```

> pm2 start app.js --name app --env production --env-file /home/ubuntu/env/.env
> .env 파일 전송 /home/ubuntu/env 폴더에 복사

### 6. [Nginx](https://wikidocs.net/223842)

#### Nginx 설치

```sh
sudo apt update
sudo apt install nginx
nginx -v

# Nginx 구동
sudo systemctl start nginx
```

#### 브라우저 테스트

```
http://서버ip:80
```

#### [Nginx를 reverse proxy server로 설정하기](https://dreaminggore00.tistory.com/8)

```sh
sudo vi /etc/nginx/sites-available/backapp
sudo rm /etc/nginx/sites-enabled/*
sudo ln -s /etc/nginx/sites-available/backapp /etc/nginx/sites-enabled/
```

```sh
server {
        listen 80;
      # listen [::]:80;

        access_log /var/log/nginx/reverse-access.log;
        error_log /var/log/nginx/reverse-error.log;

        location / {
            proxy_pass http://127.0.0.1:3000;
        }
}
```

#### Nginx 서버 재시작

```sh
# 서버 재시작
sudo systemctl reload nginx

# 서버 상태 확인
$ sudo systemctl status nginx

# 접속 로그 확인
cat /var/log/nginx/access.log

# 에러 로그 확인
cat /var/log/nginx/error.log
```

#### 브라우저 테스트

```
http://서버ip:80
```
