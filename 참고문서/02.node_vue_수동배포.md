## vue + node ë°°í¬

### í•™ìŠµëª©í‘œ

í”„ë¡œì íŠ¸ ë¹Œë“œ í›„ ìš´ì˜ëª¨ë“œ(production)ë¡œ ê°ê°ì˜ í¬íŠ¸ë¡œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ nginx 80 í¬íŠ¸ë¡œ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ë¡œë“œ ë°¸ëŸ°ì‹±

### ì‘ì—…ìˆœì„œ

<img src="./images/ë°°í¬êµ¬ì¡°.png" width="300px">

1. Vue í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
2. vueì™€ node ì—°ë™í•˜ê¸°(Vue ì •ì íŒŒì¼ ì„œë¹™ + API ì—°ê²°)
3. Naver Cloud ì„œë²„ ì¤€ë¹„ (Ubuntu ê°€ìƒ ì„œë²„)
4. ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ (Vue ë¹Œë“œ + Node ì„œë²„)
5. ì„œë²„ì— node ì„¤ì¹˜. (&, nohup)
6. PM2ë¡œ Node ì„œë²„ ì‹¤í–‰(í´ëŸ¬ìŠ¤í„° ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤)
7. Nginxë¡œ í”„ë¡ì‹œ ì„¤ì •
8. (ì„ íƒ) ë„ë©”ì¸ ì—°ê²° ë° HTTPS ì„¤ì • (Let's Encrypt)
9. github action

### 1. Vue í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ

node expressë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ Vueë¡œ ë§Œë“  ì›¹í”„ë¡ íŠ¸ë„ í•¨ê»˜ ì‹¤í–‰ë˜ë„ë¡ í•¨.

#### frontend/vue.config.js íŒŒì¼ ìˆ˜ì •

```javascript
const { defineConfig } = require("@vue/cli-service");
const path = require("path");

const server = "http://localhost:3000";

module.exports = defineConfig({
  transpileDependencies: true,
  outputDir: path.resolve("../backapp/public"),
  // ê°œë°œìš© ì„ì‹œ ì„œë²„
  devServer: {
    // Vue.js ì‹¤í–‰ ì‹œ ì ìš© PORT ë³€ê²½
    port: 8099,
    // CORS(Cross Origin Resource Sharing) => proxy setting
    proxy: {
      // í•´ë‹¹ ë¬¸ìì—´ë¡œ ì‹œì‘í•˜ëŠ” í†µì‹ ì— ì ìš©í•˜ëŠ” ì„¤ì •
      "^/api": {
        // ë³€ê²½í•  Origin
        target: server,
        // Origin ë³€ê²½ : http://localhost:8099 -> http://localhost:3000
        changeOrigin: true,
        // URL ì¤‘ ì¼ë¶€ë¶„ì„ ë‹¤ì‹œ ì‘ì„± : /api/books -> /books
        pathRewrite: { "^/api": "/" },
        // websocket ì„¤ì • ë¹„í™œì„±í™”
        ws: false,
      },
    },
  },
});
```

ë°°í¬í•  ìœ„ì¹˜ ì„¤ì •

```javascript
outputDir: path.resolve("../backapp/public"),
```

vue build

```sh
$ npm run build
```

build í›„ ìƒì„±ëœ ë°°í¬ íŒŒì¼  
<img src="./images/ë°°í¬íŒŒì¼.png" width="300px">

### 2. vueì™€ node ì—°ë™í•˜ê¸°

Nodeë§Œì„ ì‹¤í–‰í–ˆì„ ë•Œ Vueë„ í•¨ê»˜ ì‹¤í–‰ë˜ë¯€ë¡œ Vueì—ì„œ ë§Œë“  frontì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„  ì ‘ê·¼í•  urlì„ ì§€ì •.

#### backend/app.js ìˆ˜ì •

```javascript
const express = require("express");
const path = require("path");
const app = express();
const port = 3000;

app.get("/hello", (req, res) => {
  console.log(req.url);
  res.send("Hello World!");
});

app.get("/api/board", (req, res) => {
  res.send({ title: "Hello World!" });
});

//nodeì˜ routerì™€ vueì˜ routerë¥¼ ì—°ê²°
app.get("/", function (req, res, next) {
  res.sendFile(path.join(__dirname, "./public", "index.html"));
});

app.use((req, res) => {
  res.status(404).sendFile(path.join(__dirname, "./public", "index.html"));
});

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});
```

'/' endpointì— vueì˜ index.htmlì„ ë¼ìš°íŒ…í•¨.

```javascript
const path = require("path");

app.get("/", function (req, res, next) {
  res.sendFile(path.join(__dirname, "./public", "index.html"));
});
```

ìƒˆë¡œê³ ì¹¨í•´ë„ ë™ì‘í•˜ë„ë¡ 404 error ì²˜ë¦¬ ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€

```javascript
app.use((req, res) => {
  res.status(404).sendFile(path.join(__dirname, "./public", "index.html"));
});
```

#### í…ŒìŠ¤íŠ¸

ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸. nodeë§Œ ì‹¤í–‰í•´ë„ vueë„ ê°™ì´ ë™ì‘ë¨. 3000í¬íŠ¸ë¡œ í…ŒìŠ¤íŠ¸

```
http://localhost:3000
```

### 3. Naver Cloud ì„œë²„ ì¤€ë¹„ (Ubuntu ê°€ìƒ ì„œë²„)

ë„¤ì´ë²„ ì„œë²„ êµ¬ì¶• : https://devmg.tistory.com/346

### 4. ì„œë²„ì— node ì„¤ì¹˜

nvmì„ ì´ìš©í•˜ì—¬ node ì„¤ì¹˜  
nvm(node version manager) : ì—¬ëŸ¬ ê°œì˜ ë…¸ë“œ ë²„ì „ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬

```sh
# íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
sudo apt-get update

# nvm ì„¤ì¹˜
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.1/install.sh | bash
source ~/.bashrc


# nvm ì„¤ì¹˜ í™•ì¸
nvm --version

# nvm ëª…ë ¹ì–´ë¡œ nodeì™€ npmì„ ì„¤ì¹˜
nvm install 24.11.0
```

### 5. ì„œë²„ì— ì†ŒìŠ¤ ë‚´ë ¤ë°›ê¸°

```sh
# git clone
git clone https://github.com/cyannara/project.git

# .env íŒŒì¼ ì „ì†¡
```

### 6. ì„œë²„ ì‹¤í–‰

```sh
cd backend
# ë…¸ë“œ ì„œë²„ íŒ¨í‚¤ì§€ ì„¤ì¹˜
npm install
# ì„œë²„ ì‹¤í–‰
node app.js
#node app.js &
#node app.js > /dev/null 2>&1 &
#node app.js > ~/server.log 2>&1 &

# ì„œë²„ êµ¬ë™ í…ŒìŠ¤íŠ¸
curl http://localhost:3000/api/guestbook
```

ë¸Œë¼ìš°ì €ë¡œ ì„œë²„ ì—°ê²° í™•ì¸(ë°©í™”ë²½ í¬íŠ¸ 3000 ì—´ê³ ë‚˜ì„œ í™•ì¸)

```sh
http://54.180.202.222:3000
```

### 7. [PM2](https://pm2.keymetrics.io/docs/usage/quick-start/)ë¡œ Node ì„œë²„ ì‹¤í–‰

```sh
# pm2 global(ì „ì—­ ì„¤ì¹˜) íŒ¨í‚¤ì§€ë¥¼ í˜„ì¬ í”„ë¡œì íŠ¸ê°€ ì•„ë‹Œ ì‹œìŠ¤í…œì˜ node_modulesì— ì„¤ì¹˜
npm install pm2 -g

# pm2 ì‹¤í–‰
pm2 start app.js

# pm2ë¡œ ì‹¤í–‰ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
pm2 list

# í”„ë¡œì„¸ìŠ¤ ë¡œê·¸ í™•ì¸
pm2 logs app
```

### 8. [Nginx](https://wikidocs.net/223842)

![alt text](image.png)

- í”„ë¡ì‹œ ì„¤ì •
- ë¡œë“œë°¸ëŸ°ì‹±í•˜ì—¬ ë¬´ì¤‘ë‹¨ìœ¼ë¡œ ë°°í¬ í•  ìˆ˜ ìˆëŠ” í™˜ê²½ êµ¬ì„±í•˜ê¸°
- 80/443 í¬íŠ¸ ì§„ì…ì , Nodeë¡œ íŠ¸ë˜í”½ ì „ë‹¬

#### Nginx ì„¤ì¹˜

```sh
sudo apt update
sudo apt install nginx
nginx -v
```

#### Nginx êµ¬ë™

```sh
sudo systemctl start nginx        # sudo service nginx start
```

#### ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸

```
http://ì„œë²„ip:80
```

#### [Nginxë¥¼ reverse proxy serverë¡œ ì„¤ì •í•˜ê¸°](https://dreaminggore00.tistory.com/8)

```sh
sudo vi /etc/nginx/sites-available/default
```

```shell
server {
        listen 80;
      #  listen [::]:80;

        access_log /var/log/nginx/reverse-access.log;
        error_log /var/log/nginx/reverse-error.log;

        location / {
                    proxy_pass http://127.0.0.1:3000;
       }
}
```

`proxy_pass` ë¦¬ë‹¤ì´ë ‰íŠ¸í•  ì„œë²„ ì£¼ì†Œ  
`proxy_redirect` default, off, redirect replacement 3ê°€ì§€ì˜ valueë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. offëŠ” í˜¹ì‹œë‚˜ ì´ì „ ë ˆë²¨ì—ì„œ ì„¤ì •ëœ proxy_redirect ì˜í–¥ì„ ì‚­ì œì‹œí‚¤ëŠ” ê¸°ëŠ¥  
`proxy_set_header` ë¸Œë¼ìš°ì € í—¤ë”ì— ì €ì¥í•  ì •ë³´

proxy_pass http://127.0.0.1:3000/  
 proxy_pass ë’¤ì— / ê°€ ìˆìœ¼ë©´  
 /api/guestbook â†’ /guestbook ìœ¼ë¡œ ë³€í™˜ë˜ì–´ Nodeì— ì „ë‹¬ë©ë‹ˆë‹¤.

[proxy_path ì°¸ì¡°](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass)

#### Nginx ì„œë²„ ì¬ì‹œì‘

```sh
$ sudo systemctl reload nginx     # sudo service nginx restart
$ sudo systemctl status nginx
```

reloadëŠ” ì„¤ì • ë³€ê²½ ì‹œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì—†ì´ ë³€ê²½ì‚¬í•­ì„ ì ìš©í•˜ë©° ê¸°ì¡´ ì—°ê²°ì€ ìœ ì§€ë¨. restartëŠ” ì„œë¹„ìŠ¤ë¥¼ ì™„ì „íˆ ì¢…ë£Œí–ˆë‹¤ê°€ ì¬ì‹œì‘í•˜ë¯€ë¡œ ëª¨ë“  ì—°ê²°ì´ ëŠì–´ì§. ì„¤ì •íŒŒì¼ë§Œ ë³€ê²½ëœ ê²½ìš°ëŠ” reloadë¥¼ ì‚¬ìš©í•˜ê³ 

#### ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸

```
http://ì„œë²„ip:80
```

#### ë¡œê·¸ë³´ê¸°

```bash
cat /var/log/nginx/access.log
cat /var/log/nginx/error.log
```

### 9. [github action](https://docs.github.com/ko/actions)

- CI/CDë¥¼ ìœ„í•œ github ì„œë¹„ìŠ¤. githubì— push í•˜ë©´ NCP ì„œë²„ì— ìë™ ë°°í¬ë˜ë„ë¡ ì„¤ì •
- workflowë¼ê³ ë„ í•¨. íŠ¸ë¦¬ê±° ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì‹œì‘ë˜ëŠ” ì¼ë ¨ì˜ ë™ì‘ì´ë©° yaml íŒŒì¼ë¡œ ì €ì¥
- workflowëŠ” jobë“¤ë¡œ ë‚˜ëˆ ì§€ë©° ê° jobì€ ì¼ë ¨ì˜ ìŠ¤í…ì„ ìˆ˜í–‰
- [quickstart](https://docs.github.com/ko/actions/writing-workflows/quickstart) ë”°ë¼í•˜ê¸°

<img src="./images/github_action2.png" width="800">
<font size="1px"><a href="https://www.flaticon.com/kr/free-icons/vm" title="vm ì•„ì´ì½˜">Vm ì•„ì´ì½˜ ì œì‘ì: Vectors Tank - Flaticon</a></font>

#### 1) githubì—ì„œ ssh ì ‘ì† ì‹œ ì‚¬ìš©í•  í‚¤ë“¤ ìƒì„±í•˜ì—¬ ë“±ë¡

##### ë¡œì»¬ì—ì„œ ssh í‚¤ìƒì„±

```sh
# í‚¤ìƒì„±
C:\Users\user> ssh-keygen -t rsa -b 4096 -C "github-action"

C:\Users\user> cd .ssh
C:\Users\user\.ssh> dir

 Directory of C:\Users\user\.ssh

2025-05-16  ì˜¤ì „ 07:54             3,381 id_rsa
2025-05-16  ì˜¤ì „ 07:54               740 id_rsa.pub

# ë©”ëª¨ì¥ì—ì„œ ê³µìºí‚¤ íŒŒì¼ ë‚´ìš© ë³µì‚¬
C:\Users\user\.ssh>notepad id_rsa.pub
```

##### ì„œë²„ì— ê³µê°œí‚¤ ë“±ë¡

```sh
#ssh ubuntu@your-server-ip
#mkdir -p ~/.ssh
sudo vi ~/.ssh/authorized_keys
# id_rsa.pub(ê³µê°œí‚¤) ë‚´ìš©ì„ ì¶”ê°€ë¡œ ë¶™ì—¬ë„£ê¸°  o -> shift+insert -> :wq
```

##### GitHubì— Secrets ë“±ë¡

GitHub â†’ Settings â†’ Secrets â†’ Actions

| í‚¤ ì´ë¦„         | ì„¤ëª…                     |
| :-------------- | :----------------------- |
| SSH_HOST        | ì„œë²„ ì£¼ì†Œ ë˜ëŠ” IP        |
| SSH_USER        | ubuntu                   |
| SSH_PRIVATE_KEY | SSH ê°œì¸í‚¤ (id_rsa) ë‚´ìš© |

GitHub Actions ì›Œí¬í”Œë¡œìš° ì„¤ì •

#### .github/workflows/deploy.yml ìƒì„±:

- workflow : github actionì—ì„œ ì‘ì—…í•  í”„ë¡œì„¸ìŠ¤ë¥¼ ì •ì˜. (test, build,package, deploy)
- on(event) : workflowì—ì„œ ê°ì§€í•˜ëŠ” ì´ë²¤íŠ¸(push, pr)
- jobs : workflowëŠ” í•˜ë‚˜ ì´ìƒì˜ jobìœ¼ë¡œ êµ¬ì„±ë˜ë©° ë³‘ë ¬ë¡œ ì‘ì—…ì´ ì§„í–‰
- steps : í•˜ë‚˜ì˜ jobì€ ì—¬ëŸ¬ stepìœ¼ë¡œ êµ¬ì„±ë˜ë©° ì‘ì—…ìˆœì„œë¥¼ ì§€ì •. usersëŠ” ë¯¸ë¦¬ ë§Œë“¤ì–´ì§„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ê³  runì€ ëª…ë ¹ì–´ ì‹¤í–‰

```yaml
name: Build Vue and Deploy Node App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Vue app
        working-directory: ./frontend
        run: npm run build

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: SSH into server and deploy
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ~/project
            git pull origin main
            npm install --prefix backend
            pm2 restart backend || pm2 start backend/index.js --name "app"
            pm2 save
          EOF
```

## github action ì˜ˆì‹œ

```yml
name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€
on: [push]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
```

github.actor  
github.event_name  
github.ref  
github.repository  
github.workspace  
runner.os  
job.status

```yml
- name: Copy dist to backend/public
  run: |
    rm -rf backend/public
    mkdir -p backend/public
    cp -r frontend/dist/* backend/public/

- name: SSH into server and deploy
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.SSH_HOST }}
    username: ${{ secrets.SSH_USER }}
    key: ${{ secrets.SSH_KEY }}
    script: |
      cd /home/ubuntu/project
      git pull origin main
      npm install --prefix backend
      pm2 restart app || pm2 start backend/app.js --name "app"
      pm2 save
```

### referer

https://velog.io/@new_wisdom/AWS-EC2%EC%97%90-Node.jsExpress-pm2-nginx-ë°°í¬í•˜ê¸°#-ubuntu-ê¸°ë³¸-ì„¸íŒ…--nodejs-pm2-nginx-ì„¤ì¹˜
